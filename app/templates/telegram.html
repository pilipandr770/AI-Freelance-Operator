{% extends "base.html" %}
{% block title %}Telegram{% endblock %}

{% block content %}
<h2>üì± Telegram-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h2>

<div class="card">
    <h3>–°—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</h3>
    <div id="tg-status" style="margin: 1rem 0;">
        <span class="badge badge-inactive">–ü—Ä–æ–≤–µ—Ä–∫–∞...</span>
    </div>
    <div id="tg-details" style="display:none; margin-top: 1rem;">
        <table class="table" style="max-width: 400px;">
            <tr><td><strong>–ë–æ—Ç</strong></td><td id="bot-name">‚Äî</td></tr>
            <tr><td><strong>Username</strong></td><td id="bot-username">‚Äî</td></tr>
            <tr><td><strong>Owner ID</strong></td><td>{{ owner_id }}</td></tr>
        </table>
    </div>
</div>

<div class="card">
    <h3>–¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</h3>
    <p style="margin-bottom: 1rem; color: #666;">
        –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, —á—Ç–æ–±—ã —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –±–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ.
    </p>
    <button class="btn btn-success" onclick="sendTest()" id="test-btn" {% if not configured %}disabled{% endif %}>
        üöÄ –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç
    </button>
    <div id="test-result" style="margin-top: 1rem; display:none;"></div>
</div>

<div class="card">
    <h3>–°–ø–∏—Å–æ–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</h3>
    <p style="margin-bottom: 1rem; color: #666;">
        –°–∏—Å—Ç–µ–º–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–∏—Ö —Å–æ–±—ã—Ç–∏—è—Ö:
    </p>
    <table class="table">
        <thead>
            <tr><th>–°–æ–±—ã—Ç–∏–µ</th><th>–û–ø–∏—Å–∞–Ω–∏–µ</th><th>–°—Ç–∞—Ç—É—Å</th></tr>
        </thead>
        <tbody>
            <tr>
                <td>üÜï –ù–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç</td>
                <td>–ü–æ–ª—É—á–µ–Ω–æ –ø–∏—Å—å–º–æ –æ—Ç freelancer.com, —Å–æ–∑–¥–∞–Ω –ø—Ä–æ–µ–∫—Ç</td>
                <td><span class="badge badge-active">–ê–∫—Ç–∏–≤–Ω–æ</span></td>
            </tr>
            <tr>
                <td>üîç –ü—Ä–æ–≤–µ—Ä–∫–∞</td>
                <td>–ü—Ä–æ–µ–∫—Ç –ø—Ä–æ—à—ë–ª scam-—Ñ–∏–ª—å—Ç—Ä</td>
                <td><span class="badge badge-active">–ê–∫—Ç–∏–≤–Ω–æ</span></td>
            </tr>
            <tr>
                <td>üö´ –û—Ç–∫–ª–æ–Ω—ë–Ω</td>
                <td>–ü—Ä–æ–µ–∫—Ç –æ—Ç–∫–ª–æ–Ω—ë–Ω (—Å–∫–∞–º / –Ω–µ—Ä–µ–ª–µ–≤–∞–Ω—Ç)</td>
                <td><span class="badge badge-active">–ê–∫—Ç–∏–≤–Ω–æ</span></td>
            </tr>
            <tr>
                <td>üìä –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è</td>
                <td>–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ —Å–ª–æ–∂–Ω–æ—Å—Ç—å, —Å—Ç–µ–∫, –∫–∞—Ç–µ–≥–æ—Ä–∏—è</td>
                <td><span class="badge badge-active">–ê–∫—Ç–∏–≤–Ω–æ</span></td>
            </tr>
            <tr>
                <td>üí∞ –û—Ü–µ–Ω–∫–∞</td>
                <td>–†–∞—Å—Å—á–∏—Ç–∞–Ω—ã —á–∞—Å—ã –∏ —Ü–µ–Ω–∞</td>
                <td><span class="badge badge-active">–ê–∫—Ç–∏–≤–Ω–æ</span></td>
            </tr>
            <tr>
                <td>üì® –û—Ñ—Ñ–µ—Ä</td>
                <td>–ö–æ–º–º–µ—Ä—á–µ—Å–∫–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –∫–ª–∏–µ–Ω—Ç—É</td>
                <td><span class="badge badge-active">–ê–∫—Ç–∏–≤–Ω–æ</span></td>
            </tr>
            <tr>
                <td>üí¨ –û—Ç–≤–µ—Ç –∫–ª–∏–µ–Ω—Ç–∞</td>
                <td>–ö–ª–∏–µ–Ω—Ç –æ—Ç–≤–µ—Ç–∏–ª –Ω–∞ –æ—Ñ—Ñ–µ—Ä ‚Üí –ø–µ—Ä–µ–≥–æ–≤–æ—Ä—ã</td>
                <td><span class="badge badge-active">–ê–∫—Ç–∏–≤–Ω–æ</span></td>
            </tr>
            <tr>
                <td>‚úÖ –°–¥–µ–ª–∫–∞</td>
                <td>–ö–ª–∏–µ–Ω—Ç —Å–æ–≥–ª–∞—Å–∏–ª—Å—è</td>
                <td><span class="badge badge-active">–ê–∫—Ç–∏–≤–Ω–æ</span></td>
            </tr>
            <tr>
                <td>‚ö†Ô∏è –≠—Å–∫–∞–ª–∞—Ü–∏—è</td>
                <td>–î–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç —Ä–∞—É–Ω–¥–æ–≤ –ø–µ—Ä–µ–≥–æ–≤–æ—Ä–æ–≤, –Ω—É–∂–Ω–æ –≤–∞—à–µ —É—á–∞—Å—Ç–∏–µ</td>
                <td><span class="badge badge-active">–ê–∫—Ç–∏–≤–Ω–æ</span></td>
            </tr>
            <tr>
                <td>üö® –û—à–∏–±–∫–∏</td>
                <td>–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ —Å–∏—Å—Ç–µ–º—ã</td>
                <td><span class="badge badge-active">–ê–∫—Ç–∏–≤–Ω–æ</span></td>
            </tr>
        </tbody>
    </table>
</div>

{% if not configured %}
<div class="card" style="border-left: 4px solid #e74c3c;">
    <h3>‚ö†Ô∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞</h3>
    <p>Telegram –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω. –î–æ–±–∞–≤—å—Ç–µ –≤ —Ñ–∞–π–ª <code>.env</code>:</p>
    <pre style="background: #f8f9fa; padding: 1rem; border-radius: 4px; margin-top: 0.5rem;">
TELEGRAM_BOT_TOKEN=your_bot_token_here
TELEGRAM_OWNER_ID=your_telegram_id_here</pre>
    <p style="margin-top: 1rem;">
        1. –°–æ–∑–¥–∞–π—Ç–µ –±–æ—Ç–∞ —á–µ—Ä–µ–∑ <strong>@BotFather</strong> –≤ Telegram<br>
        2. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Ç–æ–∫–µ–Ω<br>
        3. –£–∑–Ω–∞–π—Ç–µ —Å–≤–æ–π ID —á–µ—Ä–µ–∑ <strong>@userinfobot</strong><br>
        4. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä
    </p>
</div>
{% endif %}

{% endblock %}

{% block extra_scripts %}
<script>
// Check Telegram status on page load
window.addEventListener('DOMContentLoaded', function() {
    fetch('/admin/telegram/status')
        .then(r => r.json())
        .then(data => {
            const statusEl = document.getElementById('tg-status');
            const detailsEl = document.getElementById('tg-details');
            if (data.connected) {
                statusEl.innerHTML = '<span class="badge badge-active">‚úÖ –ü–æ–¥–∫–ª—é—á—ë–Ω</span>';
                document.getElementById('bot-name').textContent = data.bot_name;
                document.getElementById('bot-username').textContent = '@' + data.bot_username;
                detailsEl.style.display = 'block';
            } else {
                statusEl.innerHTML = '<span class="badge badge-inactive">‚ùå –ù–µ –ø–æ–¥–∫–ª—é—á—ë–Ω: ' + 
                    (data.error || 'unknown') + '</span>';
            }
        })
        .catch(() => {
            document.getElementById('tg-status').innerHTML = 
                '<span class="badge badge-inactive">‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏</span>';
        });
});

function sendTest() {
    const btn = document.getElementById('test-btn');
    const result = document.getElementById('test-result');
    btn.disabled = true;
    btn.textContent = '‚è≥ –û—Ç–ø—Ä–∞–≤–∫–∞...';
    result.style.display = 'none';

    fetch('/admin/telegram/test', { method: 'POST' })
        .then(r => r.json())
        .then(data => {
            result.style.display = 'block';
            if (data.success) {
                result.innerHTML = '<div class="alert alert-success">‚úÖ ' + data.message + '</div>';
            } else {
                result.innerHTML = '<div class="alert alert-error">‚ùå ' + (data.error || '–û—à–∏–±–∫–∞') + '</div>';
            }
            btn.disabled = false;
            btn.textContent = 'üöÄ –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç';
        })
        .catch(err => {
            result.style.display = 'block';
            result.innerHTML = '<div class="alert alert-error">‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏</div>';
            btn.disabled = false;
            btn.textContent = 'üöÄ –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç';
        });
}
</script>
{% endblock %}
